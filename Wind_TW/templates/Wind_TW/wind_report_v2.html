{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é¢¨åŠ›è¨ˆç®—å ±å‘Šæ›¸</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;700&display=swap">
    <link rel="stylesheet" href="{% static 'css/Wind_TW/style_report_v2.css' %}">

    <!-- ã€ä¿®æ”¹ 1ã€‘: åŠ å…¥ CSS èª¿æ•´æ‘˜è¦å€å¡Šæ–‡å­—å¤§å°èˆ‡è¡Œè· -->
    <style>
        /* é‡å°é™„éŒ„é–‹é ­çš„æ‘˜è¦èªªæ˜å€å¡Š */
        .summary-box {
            font-size: 0.9rem; /* æ–‡å­—æ”¾å¤§ (åŸç‚ºé è¨­å¤§å°ï¼Œç´„æ”¾å¤§ 15%) */
            line-height: 0.5; /* è¡Œè·ç¨ç¨ç¸®å° (æ¨™æº–é€šå¸¸ç‚º 1.5 æˆ– 1.6) */
            padding: 10px; /* å¢åŠ ä¸€é»å…§è·è®“å®ƒçœ‹èµ·ä¾†æ›´èˆ’é© */
        }

        .summary-box p {
            padding: 0px; /* å¢åŠ ä¸€é»å…§è·è®“å®ƒçœ‹èµ·ä¾†æ›´èˆ’é© */
            margin: 10px;
        }

        /* ç‚ºäº†è®“æ‘˜è¦è£¡çš„å‰›æ€§/æŸ”æ€§æ–‡å­—æ›´æ˜é¡¯ï¼Œå¯é¸ */
        .summary-box strong {
            font-weight: 900;
            color: #2c3e50;
        }
    </style>

    <!-- ã€ä¿®æ”¹ 2ã€‘: MathJax è¨­å®šä¸­åŠ å…¥ç¸®æ”¾æ¯”ä¾‹ -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            // é‡å° SVG è¼¸å‡ºè¨­å®šå…¨åŸŸç¸®æ”¾
            svg: {
                fontCache: 'global',
                scale: 0.95  // ã€é—œéµä¿®æ”¹ã€‘: å°‡å…¬å¼æ–‡å­—ç¸®å°åˆ° 85%
            },
            // å¦‚æœæœªä¾†æ”¹ç”¨ CommonHTML (chtml)ï¼Œè¨­å®šæ–¹å¼å¦‚ä¸‹ï¼š
            chtml: {
                scale: 0.90
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>
<body>

<!-- æ‡¸æµ®æ“ä½œæŒ‰éˆ• -->
<div class="floating-actions" style="position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 999;">
    <button onclick="window.print()"
            style="width: 40px; height: 40px; border-radius: 50%; border:none; background:#1d3557; color:white; cursor:pointer;">
        ğŸ–¨ï¸
    </button>
    <button onclick="window.close()"
            style="width: 40px; height: 40px; border-radius: 50%; border:none; background:#666; color:white; cursor:pointer;">
        âœ•
    </button>
</div>

<!-- ================= Page 1 ================= -->
<div class="report-page">
    <div class="page-content">
        <!-- å¼•å…¥å°é¢æ¨™é¡Œ -->
        {% include "Wind_TW/partials/report_header.html" %}

        <!-- å¼•å…¥ç¬¬ä¸€ç«  -->
        {% include "Wind_TW/partials/chapter_1.html" %}

        <!-- å¼•å…¥ç¬¬äºŒç«  -->
        {% include "Wind_TW/partials/chapter_2.html" %}

    </div>
    <div class="page-number">ç¬¬ 1 é </div>
</div>

<!-- ================= Page 2 ================= -->
<div class="report-page">
    <div class="page-content">
        <!-- å¼•å…¥ç¬¬ä¸‰ç«  -->
        {% include "Wind_TW/partials/chapter_3.html" %}
    </div>
    <div class="page-number">ç¬¬ 2 é </div>
</div>
<!-- ================= Page 3 ================= -->
<div class="report-page">
    <div class="page-content">
        <!-- å¼•å…¥ç¬¬å››ç«  -->
        {% include "Wind_TW/partials/chapter_4.html" %}
    </div>
    <div class="page-number">ç¬¬ 3 é </div>
</div>

<!-- ====================================================== -->
<!-- ====       ç¬¬ 4 é ï¼š5.1 (+X) GCpi ç¬¬ä¸€çµ„             ==== -->
<!-- ====================================================== -->
<div class="report-page">
    <div class="page-content">
        {% include "Wind_TW/partials/chapter_5_content.html" with is_first_page=True case_data=chapter_5_data.plus_x section_id="5.1" direction_name="X é¢¨å‘" direction_key="X" sub_index="1" table_group=chapter_5_data.plus_x.tables.0 %}

    </div>
    <div class="page-number">ç¬¬ 4 é </div>
</div>

<!-- ====================================================== -->
<!-- ====       ç¬¬ 5 é ï¼š5.1 (+X) GCpi ç¬¬äºŒçµ„             ==== -->
<!-- ====================================================== -->
<div class="report-page">
    <div class="page-content">
        <!-- é€™è£¡ä¸å‚³ is_first_pageï¼Œæ‰€ä»¥ä¸æœƒé¡¯ç¤ºå¤§æ¨™é¡Œå’Œåœ–ç‰‡ -->
        {% include "Wind_TW/partials/chapter_5_content.html" with is_first_page=False case_data=chapter_5_data.plus_x section_id="5.1" direction_name="X é¢¨å‘" direction_key="X" sub_index="2" table_group=chapter_5_data.plus_x.tables.1 %}

    </div>
    <div class="page-number">ç¬¬ 5 é </div>
</div>

<!-- ====================================================== -->
<!-- ====       ç¬¬ 6 é ï¼š5.2 Y é¢¨å‘ (Header + GCpi 1)     ==== -->
<!-- ====================================================== -->
<div class="report-page">
    <div class="page-content">
        <!-- Y é¢¨å‘çš„ç¬¬ä¸€é ï¼Œé¡¯ç¤ºæ¨™é¡Œèˆ‡åœ–ç‰‡ -->
        {% include "Wind_TW/partials/chapter_5_content.html" with is_first_page=True case_data=chapter_5_data.plus_y section_id="5.2" direction_name="Y é¢¨å‘" direction_key="Y" sub_index="1" table_group=chapter_5_data.plus_y.tables.0 %}

    </div>
    <div class="page-number">ç¬¬ 6 é </div>
</div>

<!-- ====================================================== -->
<!-- ====       ç¬¬ 7 é ï¼š5.2 Y é¢¨å‘ (GCpi 2)              ==== -->
<!-- ====================================================== -->
<div class="report-page">
    <div class="page-content">
        {% include "Wind_TW/partials/chapter_5_content.html" with is_first_page=False case_data=chapter_5_data.plus_y section_id="5.2" direction_name="Y é¢¨å‘" direction_key="Y" sub_index="2" table_group=chapter_5_data.plus_y.tables.1 %}

    </div>
    <div class="page-number">ç¬¬ 7 é </div>
</div>

{% include "Wind_TW/partials/chapter_8_transverse.html" %}

<!-- ====================================================== -->
<!-- ====       ç¬¬ 10 é ï¼š5.4 æ‰­è½‰å‘é¢¨åŠ›                 ==== -->
<!-- ====================================================== -->
{% include "Wind_TW/partials/chapter_9_torsional.html" %}

<!-- ====================================================== -->
<!-- ====       ç¬¬ 11 é ï¼šç¬¬å…­ç«  å±€éƒ¨é¢¨å£“ (å¤–ç‰†)          ==== -->
<!-- ====================================================== -->
{% include "Wind_TW/partials/chapter_6_local_pressure.html" %}

<!-- ====================================================== -->
<!-- ====       ç¬¬ 12 é ï¼šç¬¬å…­ç«  å±€éƒ¨é¢¨å£“ (å±‹é ‚)          ==== -->
<!-- ====================================================== -->
{% include "Wind_TW/partials/chapter_6_roof.html" %}

<!-- ====================================================== -->
<!-- ====       é ç•™é é¢ (ç¬¬ 10 é )                     ==== -->
<!-- ====================================================== -->
{#{% for i in ""|make_list %}#}
{#    <div class="report-page">#}
{#        <div class="page-content">#}
{#            <div style="color: #ccc; text-align: center; margin-top: 50%;">#}
{#                æœ¬é é ç•™çµ¦å¾ŒçºŒè¨ˆç®—å…§å®¹ (ç¬¬ {{ i }} é )#}
{#            </div>#}
{##}
{#        </div>#}
{#        <div class="page-number">ç¬¬ {{ i }} é </div>#}
{#    </div>#}
{#{% endfor %}#}



<!-- ====================================================== -->
<!-- ====       é™„éŒ„ A-1ï¼šX é¢¨å‘é™£é¢¨å› å­è©³ç´°è¨ˆç®—          ==== -->
<!-- ====================================================== -->
{% if appendix_data.x_wind_g_details %}
    <div class="report-page">
        <div class="page-content">
            <!-- ä¿®æ”¹è™•ï¼šä½¿ç”¨ add éæ¿¾å™¨ä¸²æ¥å­—ä¸² " -- " + å‰›æ€§/æŸ”æ€§ + "å»ºç¯‰" -->
            {% include "Wind_TW/partials/appendix_g_factor.html" with title="é™„éŒ„ A.1 X é¢¨å‘é™£é¢¨åæ‡‰å› å­è¨ˆç®— -- "|add:appendix_data.x_wind_g_details.rigidity|add:"å»ºç¯‰" details=appendix_data.x_wind_g_details %}

        </div>
        <div class="page-number">é™„éŒ„ - 1</div>
    </div>
{% endif %}

<!-- ====================================================== -->
<!-- ====       é™„éŒ„ A-2ï¼šY é¢¨å‘é™£é¢¨å› å­è©³ç´°è¨ˆç®—          ==== -->
<!-- ====================================================== -->
{% if appendix_data.y_wind_g_details %}
    <div class="report-page">
        <div class="page-content">
            <!-- ä¿®æ”¹è™•ï¼šåŒä¸Šï¼Œé‡å° Y é¢¨å‘ä¿®æ”¹æ¨™é¡Œ -->
            {% include "Wind_TW/partials/appendix_g_factor.html" with title="é™„éŒ„ A.2 Y é¢¨å‘é™£é¢¨åæ‡‰å› å­è¨ˆç®— -- "|add:appendix_data.y_wind_g_details.rigidity|add:"å»ºç¯‰" details=appendix_data.y_wind_g_details %}

        </div>
        <div class="page-number">é™„éŒ„ - 2</div>
    </div>
{% endif %}

<!-- ====================================================== -->
<!-- ====       é™„éŒ„ Bï¼šé ç•™ç©ºç™½é                        ==== -->
<!-- ====================================================== -->
<div class="report-page">
    <div class="page-content">
        <h2 class="chapter-title">é™„éŒ„ B (å‚™è¨»èˆ‡æ‰‹ç¨¿é )</h2>
        <div style="width: 100%; height: 800px; border: 2px dashed #eee; display: flex; align-items: center; justify-content: center; color: #ccc;">
            æ­¤é ç•™ç™½ä¾›ç­†è¨˜æˆ–é»è²¼å…¶ä»–è¨ˆç®—è³‡æ–™
        </div>
    </div>
    <div class="page-number">é™„éŒ„ - 3</div>
</div>

</body>
<script>
    // æº–å‚™å»ºç¯‰ç‰©åƒæ•¸
    const bData = {
        dimX: {{ geometry_params.dim_x|default:0 }},
        dimY: {{ geometry_params.dim_y|default:0 }},
        hEave: {{ geometry_params.eave_height|default:0 }},
        hRidge: {{ geometry_params.ridge_height|default:0 }},
        h: {{ geometry_params.calculated_h|default:0 }},
        type: "{{ geometry_params.roof_shape_en }}",
        // ç¢ºä¿ç§»é™¤ "å‘" å­—ä¸¦è½‰å¤§å¯«
        ridgeDir: "{{ geometry_params.ridge_direction|default:'X' }}".replace('å‘', '').toUpperCase(),
        theta: {{ geometry_params.theta|default:0 }}
    };

    document.addEventListener("DOMContentLoaded", function () {
        drawBuildingSVG(bData, "building-schematic-svg");
    });

    function drawBuildingSVG(data, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';

        const w = container.clientWidth || 400;
        const h = container.clientHeight || 300;
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "100%");
        svg.style.display = "block";

        // å»ºç«‹ç¾¤çµ„
        const mainG = document.createElementNS(svgNS, "g");
        const uiG = document.createElementNS(svgNS, "g");
        svg.appendChild(mainG);
        svg.appendChild(uiG);

        // --- 1. æŠ•å½±ç³»çµ± ---
        // å®šç¾©ï¼š
        // Xè»¸ (Bx): æŒ‡å‘å·¦ä¸‹ (210åº¦)
        // Yè»¸ (By): æŒ‡å‘å³ä¸‹ (330åº¦)
        // Zè»¸ (h):  æŒ‡å‘å‚ç›´ä¸Š
        const angX = 210 * Math.PI / 180;
        const angY = 330 * Math.PI / 180;

        function iso(x, y, z) {
            const u = x * Math.cos(angX) + y * Math.cos(angY);
            const v = x * Math.sin(angX) + y * Math.sin(angY) - z;
            return {x: u, y: v};
        }

        // é‚Šç•Œæ”¶é›†å™¨
        let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;

        function addBounds(p) {
            if (p.x < minX) minX = p.x;
            if (p.x > maxX) maxX = p.x;
            if (p.y < minY) minY = p.y;
            if (p.y > maxY) maxY = p.y;
        }

        // --- 2. ç¹ªåœ–å‡½å¼ (åƒæ•¸æ˜ç¢ºåŒ–ï¼Œé¿å…éŒ¯èª¤) ---
        function createLine(p1, p2, color, width, dash, targetGroup) {
            const line = document.createElementNS(svgNS, "line");
            line.setAttribute("x1", p1.x);
            line.setAttribute("y1", p1.y);
            line.setAttribute("x2", p2.x);
            line.setAttribute("y2", p2.y);
            line.setAttribute("stroke", color);
            line.setAttribute("stroke-width", width);
            line.setAttribute("stroke-linecap", "round");
            if (dash) line.setAttribute("stroke-dasharray", dash);
            targetGroup.appendChild(line);
        }

        function createText(p, text, anchor, baseline, color, fontSize, weight, targetGroup) {
            const t = document.createElementNS(svgNS, "text");
            t.setAttribute("x", p.x);
            t.setAttribute("y", p.y);
            t.setAttribute("text-anchor", anchor);
            t.setAttribute("dominant-baseline", baseline);
            t.setAttribute("fill", color);
            // æš«å­˜å­—é«”å¤§å°
            t.dataset.baseFontSize = fontSize;
            t.setAttribute("font-weight", weight);
            t.setAttribute("font-family", "Arial, sans-serif");
            t.textContent = text;
            targetGroup.appendChild(t);

            // ä¼°ç®—é‚Šç•Œ
            if (targetGroup === mainG) {
                const txtW = text.length * fontSize * 0.6;
                const txtH = fontSize;
                let bx = p.x;
                if (anchor === 'middle') bx -= txtW / 2;
                else if (anchor === 'end') bx -= txtW;
                addBounds({x: bx, y: p.y - txtH / 2});
                addBounds({x: bx + txtW, y: p.y + txtH / 2});
            }
        }

        // --- 3. å®šç¾©å¹¾ä½•é ‚é» ---
        const X = data.dimX;
        const Y = data.dimY;
        const He = data.hEave;
        const Hr = data.hRidge;

        // ç‚ºäº†é…åˆæ‚¨çš„è¦–è¦ºè¦æ±‚ (Xå·¦ä¸‹, Yå³ä¸‹)ï¼š
        // åŸé» p0 (0,0) è¨­åœ¨ã€Œå¾Œè§’ã€(Back Corner)
        // p1 (X,0): å·¦è§’ (Left Corner)
        // p3 (0,Y): å³è§’ (Right Corner)
        // p2 (X,Y): å‰è§’ (Front Corner) - æœ€é è¿‘è§€å¯Ÿè€…

        const p0 = iso(0, 0, 0);
        const p1 = iso(X, 0, 0);
        const p2 = iso(X, Y, 0);
        const p3 = iso(0, Y, 0);

        const p4 = iso(0, 0, He);
        const p5 = iso(X, 0, He);
        const p6 = iso(X, Y, He);
        const p7 = iso(0, Y, He);

        [p0, p1, p2, p3, p4, p5, p6, p7].forEach(addBounds);

        // --- 4. ç¹ªè£½å»ºç¯‰ç·šæ¢ ---
        const colMain = "#333";
        const colHid = "#bbb";
        const wMain = 1.0;
        const wHid = 0.8;

        // éš±è—ç·š (å¾Œæ–¹)
        createLine(p0, p1, colHid, wHid, "4,2", mainG);
        createLine(p0, p3, colHid, wHid, "4,2", mainG);
        createLine(p0, p4, colHid, wHid, "4,2", mainG);

        // å¯è¦‹åº•é‚Š
        createLine(p1, p2, colMain, wMain, "", mainG);
        createLine(p3, p2, colMain, wMain, "", mainG);

        // å¯è¦‹æŸ±
        createLine(p1, p5, colMain, wMain, "", mainG); // å·¦æŸ±
        createLine(p2, p6, colMain, wMain, "", mainG); // å‰æŸ±
        createLine(p3, p7, colMain, wMain, "", mainG); // å³æŸ±

        // å±‹é ‚
        let ridgeRef = null; // æ¨™è¨» Hr ç”¨

        if (data.type === 'flat') {
            createLine(p4, p5, colMain, wMain, "", mainG);
            createLine(p5, p6, colMain, wMain, "", mainG);
            createLine(p6, p7, colMain, wMain, "", mainG);
            createLine(p7, p4, colMain, wMain, "", mainG);
            ridgeRef = p5;
        } else if (data.type === 'gable') {
            let rBack, rFront;

            if (data.ridgeDir === 'X') {
                // å±‹è„Šå¹³è¡Œ X è»¸ (å·¦ä¸‹ - å³ä¸Š)
                // Y å›ºå®šåœ¨ä¸­é–“ (Y/2)
                rBack = iso(0, Y / 2, Hr);  // å¾Œ (X=0)
                rFront = iso(X, Y / 2, Hr); // å‰ (X=X)

                // å¾Œå±±ç‰† (X=0é¢): p4(0,0,He), p7(0,Y,He), rBack
                createLine(p4, rBack, colMain, wMain, "", mainG);
                createLine(p7, rBack, colMain, wMain, "", mainG);

                // å‰å±±ç‰† (X=Xé¢): p5(X,0,He), p6(X,Y,He), rFront
                createLine(p5, rFront, colMain, wMain, "", mainG);
                createLine(p6, rFront, colMain, wMain, "", mainG);

                // å±‹è„Š
                createLine(rBack, rFront, colMain, wMain, "", mainG);

                // ç°·ç·š (å¹³è¡Œ X)
                createLine(p4, p5, colMain, wMain, "", mainG); // å·¦å¾Œç°·
                createLine(p7, p6, colMain, wMain, "", mainG); // å³å‰ç°·

                // æ¨™è¨»è§’åº¦åƒè€ƒç·š (å‰å±±ç‰†)
                const baseMid = iso(X, Y / 2, He);
                createLine(p5, p6, "#999", 0.5, "2,2", mainG);

                ridgeRef = rFront; // ä½¿ç”¨å‰æ–¹é«˜é»æ¨™è¨»

            } else {
                // å±‹è„Šå¹³è¡Œ Y è»¸ (å³ä¸‹ - å·¦ä¸Š)
                // X å›ºå®šåœ¨ä¸­é–“ (X/2)
                rBack = iso(X / 2, 0, Hr); // å·¦å¾Œ (Y=0)
                rFront = iso(X / 2, Y, Hr); // å³å‰ (Y=Y)

                // å·¦å¾Œå±±ç‰† (Y=0é¢): p4, p5, rBack
                createLine(p4, rBack, colMain, wMain, "", mainG);
                createLine(p5, rBack, colMain, wMain, "", mainG);

                // å³å‰å±±ç‰† (Y=Yé¢): p7, p6, rFront
                createLine(p7, rFront, colMain, wMain, "", mainG);
                createLine(p6, rFront, colMain, wMain, "", mainG);

                // å±‹è„Š
                createLine(rBack, rFront, colMain, wMain, "", mainG);

                // ç°·ç·š (å¹³è¡Œ Y)
                createLine(p4, p7, colMain, wMain, "", mainG); // å³å¾Œç°·
                createLine(p5, p6, colMain, wMain, "", mainG); // å·¦å‰ç°·

                ridgeRef = rBack; // ä½¿ç”¨å¾Œæ–¹é«˜é»æ¨™è¨» (è¼ƒé å·¦)
            }
            addBounds(rBack);
            addBounds(rFront);
        } else if (data.type === 'shed') {
            // å–®æ–œ (å¾Œé«˜å‰ä½)
            const p4_h = iso(0, 0, Hr);
            const p7_h = iso(0, Y, Hr);

            createLine(p4_h, p7_h, colMain, wMain, "", mainG); // å¾Œé«˜é‚Š
            createLine(p5, p6, colMain, wMain, "", mainG);     // å‰ä½é‚Š
            createLine(p4_h, p5, colMain, wMain, "", mainG);   // å·¦æ–œ
            createLine(p7_h, p6, colMain, wMain, "", mainG);   // å³æ–œ

            // é«˜æŸ±
            createLine(p0, p4_h, colHid, wHid, "4,2", mainG);
            createLine(p3, p7_h, colMain, wMain, "", mainG);

            ridgeRef = p4_h;
            addBounds(p4_h);
            addBounds(p7_h);
        }
        // Fallback to flat
        else {
            createLine(p4, p5, colMain, wMain, "", mainG);
            createLine(p5, p6, colMain, wMain, "", mainG);
            createLine(p6, p7, colMain, wMain, "", mainG);
            createLine(p7, p4, colMain, wMain, "", mainG);
            ridgeRef = p5;
        }

        // --- 5. å°ºå¯¸æ¨™è¨» ---
        const colDim = "#666";
        const colTxt = "#005f73";
        const dimOff = Math.max(X, Y, Hr) * 0.15;

        // 5.1 Bx (Xæ–¹å‘): æ¨™è¨»åœ¨å³ä¸‹å´ p2-p3 (Xé‚Š)
        // p2(X,Y) -> p3(0,Y). å‘é‡ (-X, 0). é•·åº¦ X.
        // å¾€ Y è»¸æ–¹å‘åç§» (å³ä¸‹)
        const bx_off = {x: dimOff * Math.cos(angY), y: dimOff * Math.sin(angY)};
        const p2_bx = {x: p2.x + bx_off.x, y: p2.y + bx_off.y};
        const p3_bx = {x: p3.x + bx_off.x, y: p3.y + bx_off.y};

        createLine(p2, p2_bx, "#999", 0.5, "", mainG);
        createLine(p3, p3_bx, "#999", 0.5, "", mainG);
        createLine(p2_bx, p3_bx, colDim, 0.8, "", mainG);

        const midBx = {x: (p2_bx.x + p3_bx.x) / 2 + 5, y: (p2_bx.y + p3_bx.y) / 2 + 5};
        createText(midBx, `Bx=${X}`, "start", "hanging", colTxt, 12, "bold", mainG);

        // 5.2 By (Yæ–¹å‘): æ¨™è¨»åœ¨å·¦ä¸‹å´ p1-p2 (Yé‚Š)
        // p1(X,0) -> p2(X,Y). å‘é‡ (0, Y). é•·åº¦ Y.
        // å¾€ X è»¸æ–¹å‘åç§» (å·¦ä¸‹)
        const by_off = {x: dimOff * Math.cos(angX), y: dimOff * Math.sin(angX)};
        const p1_by = {x: p1.x + by_off.x, y: p1.y + by_off.y};
        const p2_by = {x: p2.x + by_off.x, y: p2.y + by_off.y};

        createLine(p1, p1_by, "#999", 0.5, "", mainG);
        createLine(p2, p2_by, "#999", 0.5, "", mainG);
        createLine(p1_by, p2_by, colDim, 0.8, "", mainG);

        const midBy = {x: (p1_by.x + p2_by.x) / 2 - 5, y: (p1_by.y + p2_by.y) / 2 + 5};
        createText(midBy, `By=${Y}`, "end", "hanging", colTxt, 12, "bold", mainG);

        // 5.3 Heave (ç°·é«˜): æ¨™è¨»åœ¨æœ€å³å´ (p3 è™•)
        const he_dist = dimOff;
        const he_bot = {x: p3.x + he_dist, y: p3.y};
        const he_top = {x: p7.x + he_dist, y: p7.y};

        createLine(p3, he_bot, "#999", 0.5, "", mainG);
        createLine(p7, he_top, "#999", 0.5, "", mainG);
        createLine(he_bot, he_top, colDim, 0.8, "", mainG);
        // ç®­é ­
        createLine(he_bot, {x: he_bot.x - 2, y: he_bot.y - 3}, colDim, 0.8, "", mainG);
        createLine(he_top, {x: he_top.x - 2, y: he_top.y + 3}, colDim, 0.8, "", mainG);

        const midHe = {x: he_top.x + 5, y: (he_bot.y + he_top.y) / 2};
        createText(midHe, `heave=${He}`, "start", "middle", colTxt, 12, "normal", mainG);

        // 5.4 Hridge (è„Šé«˜): æ¨™è¨»åœ¨æœ€å·¦å´ (ridgeRef è™•)
        // å¾ ridgeRef å¾€å·¦æ‹‰
        if (Hr > He && ridgeRef) {
            const hr_dist = dimOff * 1.2;
            const hr_top = {x: ridgeRef.x - hr_dist, y: ridgeRef.y};
            const hr_bot = {x: hr_top.x, y: hr_top.y + Hr}; // å‚ç›´å‘ä¸‹ Hr

            createLine(ridgeRef, hr_top, "#999", 0.5, "2,2", mainG); // é ‚å»¶ä¼¸
            createLine(hr_top, hr_bot, colDim, 0.8, "", mainG); // å°ºå¯¸ç·š
            // åº•ç«¯é»ç·š
            createLine({x: hr_bot.x - 3, y: hr_bot.y}, {x: hr_bot.x + 3, y: hr_bot.y}, colDim, 0.8, "", mainG);
            // é ‚ç«¯é»ç·š
            createLine({x: hr_top.x - 3, y: hr_top.y}, {x: hr_top.x + 3, y: hr_top.y}, colDim, 0.8, "", mainG);

            const midHr = {x: hr_top.x - 5, y: (hr_top.y + hr_bot.y) / 2};
            createText(midHr, `hridge=${Hr}`, "end", "middle", colTxt, 12, "normal", mainG);
        }

        // --- 6. è‡ªå‹•ç¸®æ”¾ (Smart Fit) ---
        const paddingRatio = 0.05;
        const bbW = maxX - minX;
        const bbH = maxY - minY;

        if (bbW > 0.1) {
            const vbX = minX - bbW * paddingRatio;
            const vbY = minY - bbH * paddingRatio;
            const vbW = bbW * (1 + 2 * paddingRatio);
            const vbH = bbH * (1 + 2 * paddingRatio);

            svg.setAttribute("viewBox", `${vbX} ${vbY} ${vbW} ${vbH}`);

            // --- 7. ç¹ªè£½å›ºå®š UI (Scale-Invariant) ---
            const scaleFactor = vbW / w;

            // åå‘èª¿æ•´æ–‡å­—å¤§å°
            const fontSize = 14 * scaleFactor;
            mainG.querySelectorAll("text").forEach(t => t.setAttribute("font-size", fontSize));
            mainG.querySelectorAll("line").forEach(l => {
                const baseW = parseFloat(l.getAttribute("stroke-width"));
                l.setAttribute("stroke-width", baseW * scaleFactor);
            });

            // 7.1 å–®ä½ (å³ä¸Š)
            const uX = vbX + vbW - 10 * scaleFactor;
            const uY = vbY + 20 * scaleFactor;
            const tUnit = document.createElementNS(svgNS, "text");
            tUnit.setAttribute("x", uX);
            tUnit.setAttribute("y", uY);
            tUnit.setAttribute("text-anchor", "end");
            tUnit.setAttribute("font-size", 16 * scaleFactor);
            tUnit.setAttribute("fill", "#888");
            tUnit.textContent = "å–®ä½: m";
            uiG.appendChild(tUnit);

            // 7.2 Gizmo (å·¦ä¸‹)
            const gSize = 40 * scaleFactor;
            const gX = vbX + 40 * scaleFactor;
            const gY = vbY + vbH - 40 * scaleFactor;

            function drawArrow(ang, color, label) {
                const end = {
                    x: gX + gSize * Math.cos(ang),
                    y: gY + gSize * Math.sin(ang)
                };
                const l = document.createElementNS(svgNS, "line");
                l.setAttribute("x1", gX);
                l.setAttribute("y1", gY);
                l.setAttribute("x2", end.x);
                l.setAttribute("y2", end.y);
                l.setAttribute("stroke", color);
                l.setAttribute("stroke-width", 2 * scaleFactor);
                uiG.appendChild(l);

                const t = document.createElementNS(svgNS, "text");
                t.setAttribute("x", end.x + 15 * scaleFactor * Math.cos(ang));
                t.setAttribute("y", end.y + 15 * scaleFactor * Math.sin(ang));
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("dominant-baseline", "middle");
                t.setAttribute("font-size", 14 * scaleFactor);
                t.setAttribute("fill", color);
                t.setAttribute("font-weight", "bold");
                t.textContent = label;
                uiG.appendChild(t);
            }

            // ç¹ªè£½è»¸ (è§’åº¦èˆ‡ iso ä¸€è‡´)
            // SVGåº§æ¨™ Y å‘ä¸‹:
            // Xè»¸(å·¦ä¸‹): 210åº¦ (sinç‚ºè² , å‘ä¸Š? ä¸, sin(210)=-0.5. y = oy + sin. yè®Šå°=å‘ä¸Š)
            // ä¿®æ­£: SVG Yè»¸å‘ä¸‹.
            // æ•¸å­¸ 210åº¦: xè² , yè² .
            // æˆ‘å€‘è¦ å·¦ä¸‹: xè² , yæ­£.
            // æ‰€ä»¥æ˜¯ 150åº¦? cos(150) < 0, sin(150) > 0.
            // åŒæ­¥ iso å‡½å¼: Xç”¨ angX=210 (rad). cos<0, sin<0.
            // iso(1,0,0) -> x=cos(210), y=sin(210). å·¦ä¸Š?
            // é€™è£¡æœ‰é»æ··äº‚ï¼Œè®“æˆ‘å€‘ç›´æ¥å°æ‡‰ visually:
            // Xè»¸è¦æŒ‡å‘å·¦ä¸‹ -> xæ¸›å°‘, yå¢åŠ  -> æ•¸å­¸ç¬¬3è±¡é™(è‹¥Yå‘ä¸‹).

            drawArrow(angX, "#e63946", "X");
            drawArrow(angY, "#2a9d8f", "Y");
            drawArrow(-Math.PI / 2, "#457b9d", "Z"); // -90åº¦ (ä¸Š)
        }
    }
</script>
</html>