<div class="a4-page">
    <div class="report-header">
        <div class="report-title">5. 抗傾倒穩定性檢核詳細計算</div>
        <div class="report-subtitle">Overturning Stability Check</div>
    </div>

    <div class="content math-content">
        <!-- 5.1 公式 -->
        <h5 class="mt-4 border-bottom pb-2">5.1 檢核公式 (Formula)</h5>
        <div class="mb-3">
            <p>抗傾倒安全係數 ($FS_{overturning}$) 定義為對牆趾 (Toe) 之總抵抗力矩與總傾倒力矩之比值：</p>
            <div style="overflow-x: auto;">
                $$ FS_{over} = \dfrac{M_{resist}}{M_{overturn}} = \dfrac{\sum M_{weight} + \sum M_{Pv}}{M_{driving}} \ge 2.0 $$
            </div>
        </div>

        <!-- 5.2 抵抗力矩 -->
        <h5 class="mt-4 border-bottom pb-2">5.2 抵抗力矩計算 ($M_{resist}$)</h5>
        <p>包含結構自重 ($W$) 與主動土壓力之垂直分量 ($P_v$)：</p>

        <table class="table table-striped table-bordered table-sm text-center align-middle">
            <thead class="table-success">
                <tr>
                    <th>項目 (Item)</th>
                    <th>垂直力 $N$ (tf/m)</th>
                    <th>力臂 $X$ (m)</th>
                    <th>抵抗力矩 $M_R$ (tf-m/m)</th>
                </tr>
            </thead>
            <tbody>
                <!-- 結構自重迴圈 -->
                {% for block in blocks %}
                <tr>
                    <td class="text-start">{{ block.name }}</td>
                    <td>{{ block.weight|floatformat:3 }}</td>
                    <td>-</td> <!-- 這裡沒傳X臂，直接顯示計算後的 Moment -->
                    <td>{{ block.moment|floatformat:3 }}</td>
                </tr>
                {% endfor %}

                <!-- 土壓垂直分量 -->
                <tr>
                    <td class="text-start text-primary">土壓垂直分量 ($P_v$)</td>
                    <td>{{ stability.Pv_force }}</td>
                    <td>{{ stability.arm_Pv }}</td>
                    <td>{{ stability.M_resist_Pv }}</td>
                </tr>

                <!-- 總和 -->
                <tr class="table-dark fw-bold">
                    <td class="text-start">總抵抗力矩 ($M_{resist}$)</td>
                    <td>{{ stability.N_total }}</td>
                    <td>-</td>
                    <td>{{ stability.M_resist }}</td>
                </tr>
            </tbody>
        </table>

        <div class="alert alert-secondary py-2 small">
            註：$P_v$ 包含牆背摩擦力、超載垂直分量及斜背上的水重。力臂 $X$ 為合力作用點至牆趾之水平距離。
        </div>

        <!-- 5.3 傾倒力矩 -->
        <h5 class="mt-4 border-bottom pb-2">5.3 傾倒力矩計算 ($M_{overturn}$)</h5>
        <p>來自土壓力、水壓力與地震力之水平分量：</p>

        <table class="table table-striped table-bordered table-sm text-center align-middle">
            <thead class="table-danger">
                <tr>
                    <th>項目 (Item)</th>
                    <th>水平力 $P_H$ (tf/m)</th>
                    <th>力臂 $Y$ (m)</th>
                    <th>傾倒力矩 $M_O$ (tf-m/m)</th>
                </tr>
            </thead>
            <tbody>
                {% for force in driving_forces %}
                {% if force.force != 0 %}
                <tr>
                    <td class="text-start">{{ force.name }}</td>
                    <td>{{ force.force|floatformat:3 }}</td>
                    <td>{% if force.arm != '-' %}{{ force.arm|floatformat:3 }}{% else %}-{% endif %}</td>
                    <td>{{ force.moment|floatformat:3 }}</td>
                </tr>
                {% endif %}
                {% endfor %}

                <tr class="table-dark fw-bold">
                    <td class="text-start">總傾倒力矩 ($M_{overturn}$)</td>
                    <td>{{ P_total|floatformat:3 }}</td>
                    <td>{{ y_resultant|floatformat:3 }}</td>
                    <td>{{ stability.M_overturn }}</td>
                </tr>
            </tbody>
        </table>

        <!-- 5.4 結果 -->
        <h5 class="mt-4 border-bottom pb-2">5.4 安全係數檢核 ($FS$)</h5>
        <div class="alert {% if stability.FS_over >= 2.0 %}alert-success{% else %}alert-danger{% endif %}">
            $$
            \begin{aligned}
            FS_{over} &= \dfrac{ {{ stability.M_resist }} }{ {{ stability.M_overturn }} } \\[1em]
                      &= \mathbf{ {{ stability.FS_over }} }
            \end{aligned}
            $$
            <div class="text-end fw-bold mt-2">
                判定：{% if stability.FS_over >= 2.0 %} OK ( $\ge 2.0$ ) {% else %} NG ( $< 2.0$ ) {% endif %}
            </div>
        </div>

    </div>

    <div class="report-footer">
        <div class="d-flex justify-content-between">
            <span>Generated by CNProject StructTool</span>
            <span>Page 6 / 8</span>
        </div>
    </div>
</div>