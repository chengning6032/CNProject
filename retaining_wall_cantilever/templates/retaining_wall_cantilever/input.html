{% extends 'retaining_wall_cantilever/base.html' %}
{% load static %}

{% block content %}
    <div class="container mt-4">
        <h2 class="mb-4 text-center">懸臂式擋土牆設計 (L型)</h2>

        <form method="post" action="">
            {% csrf_token %}
            <div class="row">
                <!-- 左側：幾何即時預覽 -->
                <div class="col-md-6 mb-4 text-center">
                    <div class="card h-100">
                        <div class="card-header bg-secondary text-white">幾何即時預覽</div>
                        <div class="card-body d-flex flex-column align-items-center justify-content-center bg-light">
                            <canvas id="wallCanvas" width="500" height="500"
                                    style="border:1px solid #ccc; background-color: #fff; width: 100%; height: auto;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 右側：參數輸入 -->
                <div class="col-md-6">
                    <!-- 1. 材料性質 -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">1. 材料性質</div>
                        <div class="card-body">
                            <div class="mb-3 row">
                                <label class="col-sm-7 col-form-label">混凝土單位重 ($\gamma_c$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group">
                                        <input type="number" step="0.01" class="form-control" name="gamma_c"
                                               value="{{ input_data.gamma_c|default:'2.4' }}" required>
                                        <span class="input-group-text">tf/m³</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2. 牆身幾何 -->
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">2. 牆身幾何 [cm]</div>
                        <div class="card-body">
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">牆身高度 ($H_{stem}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="H_stem"
                                                                    name="H_stem"
                                                                    value="{{ input_data.H_stem|default:'300' }}"
                                                                    required><span class="input-group-text">cm</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">牆頂厚度 ($t_{top}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="t_stem_top"
                                                                    name="t_stem_top"
                                                                    value="{{ input_data.t_stem_top|default:'30' }}"
                                                                    required><span class="input-group-text">cm</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">前側斜率底寬 ($w_{f}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="w_stem_front"
                                                                    name="w_stem_front"
                                                                    value="{{ input_data.w_stem_front|default:'0' }}"><span
                                            class="input-group-text">cm</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">後側斜率底寬 ($w_{b}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="w_stem_back"
                                                                    name="w_stem_back"
                                                                    value="{{ input_data.w_stem_back|default:'0' }}"><span
                                            class="input-group-text">cm</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. 基版幾何 -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">3. 基版幾何 [cm]</div>
                        <div class="card-body">
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">基版厚度 ($H_{bp}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="H_bp" name="H_bp"
                                                                    value="{{ input_data.H_bp|default:'50' }}" required><span
                                            class="input-group-text">cm</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">趾部長度 ($L_{f}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="L_bp_front"
                                                                    name="L_bp_front"
                                                                    value="{{ input_data.L_bp_front|default:'100' }}"
                                                                    required><span class="input-group-text">cm</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">踵部長度 ($L_{b}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="L_bp_back"
                                                                    name="L_bp_back"
                                                                    value="{{ input_data.L_bp_back|default:'200' }}"
                                                                    required><span class="input-group-text">cm</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3-1. 牆背回填土 -->
                    <div class="card mb-3 border-primary">
                        <div class="card-header bg-primary text-white">3-1. 牆背回填土 (Backfill Soil) - 主動側</div>
                        <div class="card-body">
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">濕單位重
                                ($\gamma_{t1}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="gamma_soil"
                                                                    value="{{ input_data.gamma_soil|default:'1.8' }}"
                                                                    required><span class="input-group-text">tf/m³</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">飽和單位重
                                ($\gamma_{sat1}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="gamma_sat"
                                                                    value="{{ input_data.gamma_sat|default:'2.0' }}"
                                                                    required><span class="input-group-text">tf/m³</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">摩擦角 ($\phi_1$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="phi_soil"
                                                                    value="{{ input_data.phi_soil|default:'30' }}"
                                                                    required><span class="input-group-text">deg</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">牆摩擦角 ($\delta_1$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="delta_wall"
                                                                    value="{{ input_data.delta_wall|default:'15' }}"
                                                                    required><span class="input-group-text">deg</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">凝聚力 ($c'_1$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="c_soil"
                                                                    value="{{ input_data.c_soil|default:'0' }}"><span
                                            class="input-group-text">tf/m²</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">地表傾角 ($\alpha$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01"
                                                                    class="form-control geo-input" name="alpha_soil"
                                                                    value="{{ input_data.alpha_soil|default:'0' }}"><span
                                            class="input-group-text">deg</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">回填土高度
                                ($H_{fill}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1" class="form-control"
                                                                    name="H_fill"
                                                                    value="{{ input_data.H_fill|default:'' }}"
                                                                    placeholder="預設=牆高"><span
                                            class="input-group-text">cm</span></div>
                                    <small class="text-muted">版頂起算</small></div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">地下水位 ($H_w$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1" class="form-control"
                                                                    name="H_water"
                                                                    value="{{ input_data.H_water|default:'0' }}"><span
                                            class="input-group-text">cm</span></div>
                                    <small class="text-muted">版底起算</small></div>
                            </div>
                        </div>
                    </div>

                    <!-- 3-2. 牆前覆土 -->
                    <div class="card mb-3 border-success">
                        <div class="card-header bg-success text-white">3-2. 牆前覆土 (Front Soil) - 被動側</div>
                        <div class="card-body">
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">牆前覆土高
                                ($H_{front}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1" class="form-control"
                                                                    name="H_soil_front"
                                                                    value="{{ input_data.H_soil_front|default:'50' }}"><span
                                            class="input-group-text">cm</span></div>
                                    <small class="text-muted">版頂起算</small></div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">濕單位重
                                ($\gamma_{t2}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="gamma_soil_front"
                                                                    value="{{ input_data.gamma_soil_front|default:'1.8' }}"><span
                                            class="input-group-text">tf/m³</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">飽和單位重
                                ($\gamma_{sat2}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="gamma_sat_front"
                                                                    value="{{ input_data.gamma_sat_front|default:'2.0' }}"><span
                                            class="input-group-text">tf/m³</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">摩擦角 ($\phi_2$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="phi_soil_front"
                                                                    value="{{ input_data.phi_soil_front|default:'30' }}"><span
                                            class="input-group-text">deg</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">凝聚力 ($c'_2$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="c_soil_front"
                                                                    value="{{ input_data.c_soil_front|default:'0' }}"><span
                                            class="input-group-text">tf/m²</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3-3. 基礎版底土壤 -->
                    <div class="card mb-3 border-dark">
                        <div class="card-header bg-dark text-white">3-3. 基礎版底土壤 (Base Soil) - 止滑/承載</div>
                        <div class="card-body">
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">濕單位重
                                ($\gamma_{t3}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="gamma_soil_base"
                                                                    value="{{ input_data.gamma_soil_base|default:'1.9' }}"
                                                                    required><span class="input-group-text">tf/m³</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">飽和單位重
                                ($\gamma_{sat3}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="gamma_sat_base"
                                                                    value="{{ input_data.gamma_sat_base|default:'2.1' }}"
                                                                    required><span class="input-group-text">tf/m³</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">摩擦角 ($\phi_3$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="phi_soil_base"
                                                                    value="{{ input_data.phi_soil_base|default:'32' }}"
                                                                    required><span class="input-group-text">deg</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">凝聚力 ($c'_3$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="c_soil_base"
                                                                    value="{{ input_data.c_soil_base|default:'0' }}"><span
                                            class="input-group-text">tf/m²</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3-4. 超載 -->
                    <div class="card mb-3">
                        <div class="card-header bg-dark text-white">3-4. 超載 (Surcharge)</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <select class="form-select" id="surcharge_type" name="surcharge_type"
                                        onchange="toggleSurchargeInputs()">
                                    <option value="none"
                                            {% if input_data.surcharge_type == 'none' %}selected{% endif %}>無
                                    </option>
                                    <option value="uniform"
                                            {% if input_data.surcharge_type == 'uniform' %}selected{% endif %}>無限均佈
                                    </option>
                                    <option value="strip"
                                            {% if input_data.surcharge_type == 'strip' %}selected{% endif %}>帶狀載重
                                    </option>
                                </select>
                            </div>
                            <div id="input_uniform" style="display:none;">
                                <div class="mb-2 row"><label class="col-sm-7 col-form-label">強度 ($q$):</label>
                                    <div class="col-sm-5">
                                        <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                        name="q_uniform"
                                                                        value="{{ input_data.q_uniform|default:'0' }}"><span
                                                class="input-group-text">tf/m²</span></div>
                                    </div>
                                </div>
                            </div>
                            <div id="input_strip" style="display:none;">
                                <div class="mb-2 row"><label class="col-sm-7 col-form-label">強度 ($q$):</label>
                                    <div class="col-sm-5">
                                        <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                        name="q_strip"
                                                                        value="{{ input_data.q_strip|default:'0' }}"><span
                                                class="input-group-text">tf/m²</span></div>
                                    </div>
                                </div>
                                <div class="mb-2 row"><label class="col-sm-7 col-form-label">距離 ($x$):</label>
                                    <div class="col-sm-5">
                                        <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                        name="strip_x"
                                                                        value="{{ input_data.strip_x|default:'0' }}"><span
                                                class="input-group-text">m</span></div>
                                    </div>
                                </div>
                                <div class="mb-2 row"><label class="col-sm-7 col-form-label">寬度 ($B$):</label>
                                    <div class="col-sm-5">
                                        <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                        name="strip_B"
                                                                        value="{{ input_data.strip_B|default:'0' }}"><span
                                                class="input-group-text">m</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3-5. 地震參數 -->
                    <div class="card mb-3">
                        <div class="card-header bg-danger text-white">3-5. 地震參數 (Seismic)</div>
                        <div class="card-body">
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">水平震度 ($k_h$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="kh"
                                                                    value="{{ input_data.kh|default:'0.12' }}"></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">垂直震度 ($k_v$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.01" class="form-control"
                                                                    name="kv" value="{{ input_data.kv|default:'0' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 4. 止滑榫 -->
                    <div class="card mb-3">
                        <div class="card-header bg-warning text-dark">4. 止滑榫 (Key) [cm]</div>
                        <div class="card-body">
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">深度 ($H_{sk}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="H_sk" name="H_sk"
                                                                    value="{{ input_data.H_sk|default:'0' }}"><span
                                            class="input-group-text">cm</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">寬度 ($L_{sk}$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="L_sk" name="L_sk"
                                                                    value="{{ input_data.L_sk|default:'0' }}"><span
                                            class="input-group-text">cm</span></div>
                                </div>
                            </div>
                            <div class="mb-2 row"><label class="col-sm-7 col-form-label">位置 ($x_1$):</label>
                                <div class="col-sm-5">
                                    <div class="input-group"><input type="number" step="0.1"
                                                                    class="form-control geo-input" id="x_1" name="x_1"
                                                                    value="{{ input_data.x_1|default:'0' }}"><span
                                            class="input-group-text">cm</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">開始計算</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    {% include 'retaining_wall_cantilever/result_modal.html' %}

    <script>
        function toggleSurchargeInputs() {
            const type = document.getElementById('surcharge_type').value;
            const u = document.getElementById('input_uniform');
            const s = document.getElementById('input_strip');
            if (u && s) {
                u.style.display = (type === 'uniform') ? 'block' : 'none';
                s.style.display = (type === 'strip') ? 'block' : 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('surcharge_type')) toggleSurchargeInputs();
            {% if result_available %}
                var myModal = new bootstrap.Modal(document.getElementById('resultModal'), {keyboard: false});
                myModal.show();
            {% endif %}
        });
        window.MathJax = {tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]}};
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
{% endblock %}

{% block extra_js %}
    <script src="{% static 'js/retaining_wall_cantilever/retaining_wall_draw.js' %}"></script>
{% endblock %}