<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>懸臂式擋土牆計算書</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #525659;
            padding: 20px 0;
            font-family: "Times New Roman", "微軟正黑體", sans-serif;
        }

        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            margin: 0 auto 30px auto;
            padding: 20mm;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
            position: relative;
            box-sizing: border-box;
            overflow: hidden;
        }

        .floating-controls {
            position: fixed;
            top: 20px;
            right: 30px;
            z-index: 10001;
        }

        .report-header {
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .report-footer {
            position: absolute;
            bottom: 15mm;
            left: 20mm;
            right: 20mm;
            border-top: 1px solid #ccc;
            padding-top: 5px;
            font-size: 0.8rem;
            color: #666;
        }

        h4 {
            border-left: 5px solid #0d6efd;
            padding-left: 10px;
            margin-top: 20px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .table-prop th {
            background-color: #f8f9fa;
            width: 30%;
            font-weight: bold;
        }

        /* SVG 樣式 */
        svg {
            width: 100%;
            height: 100%;
        }

        text {
            font-family: Arial, sans-serif;
            pointer-events: none;
        }

        @media print {
            body {
                background: none;
                padding: 0;
            }

            .floating-controls {
                display: none !important;
            }

            .a4-page {
                width: 100%;
                margin: 0;
                box-shadow: none;
                page-break-after: always;
            }
        }
    </style>
    <script>
        window.MathJax = {tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]}, svg: {fontCache: 'global'}};
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>

<div class="floating-controls">
    <button class="btn btn-primary btn-lg shadow me-2" onclick="window.print()"><i class="bi bi-printer"></i> 列印 / PDF
    </button>
    <button class="btn btn-secondary btn-lg shadow" onclick="window.close()"><i class="bi bi-x-lg"></i> 關閉</button>
</div>

{% if not result_available %}
    <div class="a4-page d-flex align-items-center justify-content-center">
        <div class="text-center"><h3>無計算資料</h3></div>
    </div>
{% else %}

    <!-- P1: 摘要 -->
    <div class="a4-page">
        <div class="report-header"><h2>懸臂式擋土牆結構計算書</h2>
            <p>Retaining Wall Design Report</p></div>
        <div class="content">
            <h4>1. 設計條件摘要</h4>
            <table class="table table-bordered table-sm">
                <tr>
                    <th class="table-light">牆高</th>
                    <td>{{ input_data.H_stem|add:input_data.H_bp }} cm (Stem+Base)</td>
                    <th class="table-light">回填高</th>
                    <td>{{ input_data.H_fill }} cm</td>
                </tr>
                <tr>
                    <th class="table-light">水位</th>
                    <td>{{ input_data.H_water }} cm</td>
                    <th class="table-light">地震</th>
                    <td>$k_h={{ input_data.kh }}$, $k_v={{ input_data.kv }}$</td>
                </tr>
            </table>
            <h4>2. 穩定性檢核 (Stability Check)</h4>
            <table class="table table-striped table-bordered text-center align-middle">
                <thead class="table-dark">
                <tr>
                    <th>項目</th>
                    <th>計算值</th>
                    <th>抵抗/驅動</th>
                    <th>狀態</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>抗滑</td>
                    <td class="fs-5 fw-bold {% if stability.FS_slide < 1.5 %}text-danger{% else %}text-success{% endif %}">
                        FS={{ stability.FS_slide }}</td>
                    <td>{{ stability.F_resist }}/{{ stability.F_driving }}</td>
                    <td>{{ stability.FS_slide|yesno:"OK,NG" }}</td>
                </tr>
                <tr>
                    <td>抗傾</td>
                    <td class="fs-5 fw-bold {% if stability.FS_over < 2.0 %}text-danger{% else %}text-success{% endif %}">
                        FS={{ stability.FS_over }}</td>
                    <td>{{ stability.M_resist }}/{{ stability.M_overturn }}</td>
                    <td>{{ stability.FS_over|yesno:"OK,NG" }}</td>
                </tr>
                <tr>
                    <td>偏心</td>
                    <td>e={{ stability.Eccentricity }}</td>
                    <td>Limit={{ stability.B_over_6 }}</td>
                    <td>OK</td>
                </tr>
                </tbody>
            </table>
            <h4>3. 土壓力係數</h4>
            <table class="table table-sm table-bordered text-center">
                <thead class="table-secondary">
                <tr>
                    <th>Ka</th>
                    <th>Kae</th>
                    <th>Kp (前)</th>
                    <th>Kpe (榫)</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>{{ Ka }}</td>
                    <td>{{ Kae }}</td>
                    <td>{{ Kp }}</td>
                    <td>{{ Kpe_base }}</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="report-footer">
            <div class="d-flex justify-content-between"><span>Generated by CNProject</span><span>Page 1 / 8</span></div>
        </div>
    </div>

    <!-- P2: 基本性質 -->
    <div class="a4-page">
        <div class="report-header"><h4>1. 基本性質 (Basic Properties)</h4></div>
        <div class="content">
            <h5 class="mt-4">1.1 擋土牆幾何</h5>
            <table class="table table-bordered table-sm table-prop">
                <tbody>
                <tr>
                    <th>H_stem</th>
                    <td>{{ input_data.H_stem }} cm</td>
                    <th>t_top</th>
                    <td>{{ input_data.t_stem_top }} cm</td>
                </tr>
                <tr>
                    <th>H_bp</th>
                    <td>{{ input_data.H_bp }} cm</td>
                    <th>L_toe</th>
                    <td>{{ input_data.L_bp_front }} cm</td>
                </tr>
                </tbody>
            </table>
            <h5 class="mt-4">1.2 材料與土壤</h5>
            <h6 class="fw-bold text-secondary mt-3">Backfill (Active)</h6>
            <table class="table table-bordered table-sm table-prop">
                <tbody>
                <tr>
                    <th>Gamma</th>
                    <td>{{ input_data.gamma_soil }}</td>
                    <th>Phi</th>
                    <td>{{ input_data.phi_soil }}</td>
                </tr>
                </tbody>
            </table>
            <h6 class="fw-bold text-secondary mt-3">Front Soil (Passive)</h6>
            <table class="table table-bordered table-sm table-prop">
                <tbody>
                <tr>
                    <th>H_front</th>
                    <td>{{ input_data.H_soil_front }}</td>
                    <th>Phi</th>
                    <td>{{ input_data.phi_soil_front }}</td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="report-footer">
            <div class="d-flex justify-content-between"><span>Generated by CNProject</span><span>Page 2 / 8</span></div>
        </div>
    </div>

    <!-- P3: SVG -->
    <div class="a4-page">
        <div class="report-header"><h4>2. 擋土牆分析模型圖</h4></div>
        <div class="content d-flex flex-column align-items-center justify-content-center" style="height: 220mm;">
            <div id="svg-container" style="width: 100%; height: 100%; border: 1px dashed #ccc;"></div>
        </div>
        <div class="report-footer">
            <div class="d-flex justify-content-between"><span>Generated by CNProject</span><span>Page 3 / 8</span></div>
        </div>
    </div>

    <!-- P4: 參數計算 -->
    <div class="a4-page">
        <div class="report-header"><h4>3. 設計參數詳細計算</h4></div>
        <div class="content">
            <h5 class="mt-4 border-bottom pb-2">3.1 角度參數</h5>
            <div class="row">
                <div class="col-6"><p>$\theta = \tan^{-1}(w_b/H) = \mathbf{<span id="val_theta"></span>^\circ}$</p>
                </div>
                <div class="col-6"><p>$\psi = \tan^{-1}(k_h/(1-k_v)) = \mathbf{<span id="val_psi"></span>^\circ}$</p>
                </div>
            </div>
            <h5 class="mt-4 border-bottom pb-2">3.2 主動係數</h5>
            <div class="mb-4"><h6>(1) Static $K_a$</h6>$$ K_a = \dfrac{ \cos^2(\phi - \theta) }{ \cos^2\theta
                \cos(\theta+\delta) \left[ 1 + \sqrt{
                \dfrac{\sin(\phi+\delta)\sin(\phi-\alpha)}{\cos(\theta+\delta)\cos(\theta-\alpha)} } \right]^2 } $$ <p
                        class="text-end">$K_a = \mathbf{ {{ Ka }} }$</p></div>
            <div class="mb-4"><h6>(2) Dynamic $K_{AE}$</h6>
                <p class="small text-muted">(Mononobe-Okabe)</p>
                <p class="text-end">$K_{AE} = \mathbf{ {{ Kae }} }$</p></div>
            <h5 class="mt-4 border-bottom pb-2">3.3 被動係數</h5>
            <div class="mb-4"><h6>(1) Static $K_p$ (Caquot-Kerisel)</h6>
                <p class="text-end">$K_p = \mathbf{ {{ Kp }} }$</p></div>
            <div class="alert alert-warning py-2 small">止滑榫修正後 $K_{pe} = \mathbf{ {{ Kpe_base }} }$</div>
        </div>
        <div class="report-footer">
            <div class="d-flex justify-content-between"><span>Generated by CNProject</span><span>Page 4 / 8</span></div>
        </div>
    </div>

    <!-- 第 5~8 頁 -->
    {% for i in "5678" %}
        <div class="a4-page">
            <div class="report-header"><h4>詳細計算過程 (續)</h4></div>
            <div class="page-content d-flex justify-content-center align-items-center" style="height: 200mm;">
                <p class="text-muted">(Page {{ i }})</p>
            </div>
            <div class="page-footer">
                <div class="d-flex justify-content-between">
                    <span>Generated by CNProject</span><span>Page {{ i }} / 8</span></div>
            </div>
        </div>
    {% endfor %}

{% endif %}

<!-- SVG Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        renderWallSVG();
        // Calc Angles
        let wb = parseFloat("{{ input_data.w_stem_back }}");
        let H = parseFloat("{{ input_data.H_stem }}");
        if (H > 0) document.getElementById('val_theta').innerText = (Math.atan(wb / H) * 180 / Math.PI).toFixed(2);

        let kh = parseFloat("{{ input_data.kh }}");
        let kv = parseFloat("{{ input_data.kv }}");
        if ((1 - kv) !== 0) document.getElementById('val_psi').innerText = (Math.atan(kh / (1 - kv)) * 180 / Math.PI).toFixed(2);
    });

    function renderWallSVG() {
        const d = {
            H_stem: parseFloat("{{ input_data.H_stem }}") || 300,
            t_top: parseFloat("{{ input_data.t_stem_top }}") || 30,
            w_front: parseFloat("{{ input_data.w_stem_front }}") || 0,
            w_back: parseFloat("{{ input_data.w_stem_back }}") || 20,
            H_bp: parseFloat("{{ input_data.H_bp }}") || 50,
            L_front: parseFloat("{{ input_data.L_bp_front }}") || 100,
            L_back: parseFloat("{{ input_data.L_bp_back }}") || 200,
            H_sk: parseFloat("{{ input_data.H_sk }}") || 0,
            L_sk: parseFloat("{{ input_data.L_sk }}") || 0,
            x_1: parseFloat("{{ input_data.x_1 }}") || 0,
            H_fill: ("{{ input_data.H_fill }}") ? parseFloat("{{ input_data.H_fill }}") : parseFloat("{{ input_data.H_stem }}"),
            H_water: parseFloat("{{ input_data.H_water }}") || 0,
            alpha: parseFloat("{{ input_data.alpha_soil }}") || 0,
            H_soil_front: parseFloat("{{ input_data.H_soil_front }}") || 50
        };
        const t_bot = d.w_front + d.t_top + d.w_back;
        const B_total = d.L_front + t_bot + d.L_back;
        const container = document.getElementById('svg-container');
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");

        // Scale Logic (變數名稱修正：totalWidth, totalHeight)
        let extraHeight = (d.alpha > 0) ? (B_total * 0.8) * Math.tan(d.alpha * Math.PI / 180) : 0;
        const totalWidth = B_total * 1.6;
        const totalHeight = Math.max(d.H_bp + d.H_fill + extraHeight, d.H_bp + d.H_stem) + d.H_sk + 50;

        // 預設 A4 繪圖區大小 (避免未渲染時讀不到 rect)
        const availW = 700;
        const availH = 800;

        const scale = Math.min(availW / totalWidth, availH / totalHeight) * 0.8;
        const offX = (availW - totalWidth * scale) / 2 + 50;
        const offY = (availH - totalHeight * scale) / 2 + (Math.max(d.H_bp + d.H_fill + extraHeight, d.H_bp + d.H_stem)) * scale + 50;

        function toSVG(x, y) {
            return {x: offX + x * scale, y: offY - y * scale};
        }

        function createLine(p1, p2, c, w = 2, dash = null) {
            const l = document.createElementNS(svgNS, "line");
            l.setAttribute("x1", p1.x);
            l.setAttribute("y1", p1.y);
            l.setAttribute("x2", p2.x);
            l.setAttribute("y2", p2.y);
            l.setAttribute("stroke", c);
            l.setAttribute("stroke-width", w);
            if (dash) l.setAttribute("stroke-dasharray", dash);
            svg.appendChild(l);
        }

        function createPoly(pts, fill, str) {
            const p = document.createElementNS(svgNS, "path");
            p.setAttribute("d", "M " + pts.map(pt => `${pt.x},${pt.y}`).join(" L ") + " Z");
            p.setAttribute("fill", fill);
            p.setAttribute("stroke", str);
            p.setAttribute("stroke-width", 2);
            svg.appendChild(p);
        }

        function createText(x, y, txt, c) {
            const t = document.createElementNS(svgNS, "text");
            t.setAttribute("x", x);
            t.setAttribute("y", y);
            t.setAttribute("fill", c);
            t.setAttribute("text-anchor", "middle");
            t.setAttribute("font-size", "12");
            t.textContent = txt;
            svg.appendChild(t);
        }

        function drawDim(p1_cm, p2_cm, txt, off, orient) {
            const c1 = toSVG(p1_cm.x, p1_cm.y), c2 = toSVG(p2_cm.x, p2_cm.y);
            const c = "#0056b3", gap = 5;
            if (orient === 'H') {
                const yl = c1.y - off;
                createLine({x: c1.x, y: c1.y - (off > 0 ? gap : -gap)}, {x: c1.x, y: yl}, c, 1);
                createLine({x: c2.x, y: c2.y - (off > 0 ? gap : -gap)}, {x: c2.x, y: yl}, c, 1);
                createLine({x: c1.x, y: yl}, {x: c2.x, y: yl}, c, 1);
                createText((c1.x + c2.x) / 2, yl - (off > 0 ? 5 : -15), txt, c);
            } else {
                const xl = c1.x - off;
                createLine({x: c1.x - (off > 0 ? gap : -gap), y: c1.y}, {x: xl, y: c1.y}, c, 1);
                createLine({x: c2.x - (off > 0 ? gap : -gap), y: c2.y}, {x: xl, y: c2.y}, c, 1);
                createLine({x: xl, y: c1.y}, {x: xl, y: c2.y}, c, 1);

                const t = document.createElementNS(svgNS, "text");
                t.setAttribute("x", xl - (off > 0 ? 5 : -15));
                t.setAttribute("y", (c1.y + c2.y) / 2);
                t.setAttribute("fill", c);
                t.setAttribute("text-anchor", "middle");
                t.setAttribute("font-size", "12");
                t.setAttribute("transform", `rotate(-90, ${xl - (off > 0 ? 5 : -15)}, ${(c1.y + c2.y) / 2})`);
                t.textContent = txt;
                svg.appendChild(t);
            }
        }

        // Draw Sequence
        // 1. Structure
        const pt_toe = toSVG(0, 0);
        const pt_top = toSVG(0, d.H_bp);
        const pt_sf_b = toSVG(d.L_front, d.H_bp);
        const pt_sf_t = toSVG(d.L_front + d.w_front, d.H_bp + d.H_stem);
        const pt_sb_t = toSVG(d.L_front + d.w_front + d.t_top, d.H_bp + d.H_stem);
        const pt_sb_b = toSVG(B_total - d.L_back, d.H_bp);
        const pt_heel = toSVG(B_total, d.H_bp);
        let wallPts = [pt_toe, pt_top, pt_sf_b, pt_sf_t, pt_sb_t, pt_sb_b, pt_heel];

        if (d.H_sk > 0) {
            const x_sk_r = B_total - d.x_1;
            const x_sk_l = x_sk_r - d.L_sk;
            wallPts.push(toSVG(B_total, 0));
            wallPts.push(toSVG(x_sk_r, 0));
            wallPts.push(toSVG(x_sk_r, -d.H_sk));
            wallPts.push(toSVG(x_sk_l, -d.H_sk));
            wallPts.push(toSVG(x_sk_l, 0));
        } else {
            wallPts.push(toSVG(B_total, 0));
        }
        createPoly(wallPts, "#d3d3d3", "#333");

        // 2. Backfill (修正變數 totalWidth)
        let x_s_s = (d.H_fill <= d.H_stem) ? (B_total - d.L_back) - (d.H_fill * (d.w_back / d.H_stem)) : (d.L_front + d.w_front + d.t_top);
        let y_s_s = d.H_bp + d.H_fill;
        let x_s_e = totalWidth;
        let y_s_e = y_s_s + (x_s_e - x_s_s) * Math.tan(d.alpha * Math.PI / 180);
        createLine(toSVG(x_s_s, y_s_s), toSVG(x_s_e, y_s_e), "#4CAF50", 2, "5,5");
        createText(toSVG(x_s_e, y_s_e).x - 40, toSVG(x_s_e, y_s_e).y - 10, "Backfill", "#4CAF50");

        // 3. Front Soil
        let y_f = d.H_bp + d.H_soil_front;
        createLine(toSVG(d.L_front, y_f), toSVG(-50, y_f), "#D2691E", 2, "5,5");
        createText(toSVG(-50, y_f).x + 20, toSVG(-50, y_f).y - 5, "Front", "#D2691E");

        // 4. Water (修正變數 totalWidth)
        if (d.H_water > 0) {
            let x_w_s = B_total - d.L_back; // approximate start
            createLine(toSVG(x_w_s, d.H_water), toSVG(totalWidth, d.H_water), "#2196F3", 2, "10,5");
            createText(toSVG(totalWidth, d.H_water).x - 50, toSVG(0, d.H_water).y - 10, "GWL", "#2196F3");
        }

        // 5. Dims
        drawDim({x: d.L_front, y: d.H_bp}, {x: d.L_front, y: d.H_bp + d.H_stem}, `H=${d.H_stem}`, 40, 'V');
        drawDim({x: 0, y: 0}, {x: B_total, y: 0}, `B=${B_total}`, -45, 'H');

        container.appendChild(svg);
    }
</script>
</body>
</html>