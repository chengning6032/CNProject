<!-- 計算結果模態視窗 -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">

            <!-- Header -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="resultModalLabel">
                    <i class="bi bi-calculator"></i> 計算結果報告 (Analysis Report)
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
            </div>

            <!-- Body -->
            <div class="modal-body">
                {% if result_available %}

                    <!-- 導覽分頁 (Nav Tabs) -->
                    <ul class="nav nav-tabs mb-3" id="resultTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="summary-tab" data-bs-toggle="tab"
                                    data-bs-target="#summary" type="button" role="tab">1. 設計係數
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="driving-tab" data-bs-toggle="tab" data-bs-target="#driving"
                                    type="button" role="tab">2. 主動驅動力
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="resisting-tab" data-bs-toggle="tab" data-bs-target="#resisting"
                                    type="button" role="tab">3. 被動抵抗力
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="weight-tab" data-bs-toggle="tab" data-bs-target="#weight"
                                    type="button" role="tab">4. 結構自重
                            </button>
                        </li>
                    </ul>

                    <!-- 分頁內容 -->
                    <div class="tab-content" id="resultTabsContent">

                        <!-- Tab 1: 設計係數 -->
                        <div class="tab-pane fade show active" id="summary" role="tabpanel">
                            <div class="alert alert-info">
                                <h5 class="alert-heading fw-bold">土壓力係數</h5>
                                <div class="row text-center mt-3">
                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-header">主動 Active</div>
                                            <div class="card-body"><p>Ka = <strong>{{ Ka }}</strong></p>
                                                <p>Kae = <strong>{{ Kae }}</strong></p></div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-header">被動 Passive (牆前)</div>
                                            <div class="card-body"><p>Kp = <strong>{{ Kp }}</strong></p>
                                                <p>Kpe = <strong>{{ Kpe }}</strong></p></div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-header">被動 Passive (止滑榫)</div>
                                            <div class="card-body"><p>Kp = <strong>{{ Kp_base }}</strong></p>
                                                <p>Kpe(Corr) = <strong>{{ Kpe_base }}</strong></p></div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary text-white">設計條件</div>
                                            <div class="card-body text-start"><small>地震: kh={{ input_data.kh }},
                                                kv={{ input_data.kv }}<br>超載: {{ surcharge_info.type }}<br>水位: {{ input_data.H_water }}
                                                m</small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab 2: 驅動力 -->
                        <div class="tab-pane fade" id="driving" role="tabpanel">
                            <h5 class="text-danger border-bottom pb-2">水平驅動力總表</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover text-center align-middle">
                                    <thead class="table-danger">
                                    <tr>
                                        <th>分量名稱</th>
                                        <th>水平力 Ph (tf/m)</th>
                                        <th>力臂 Y (m)</th>
                                        <th>傾倒力矩 (tf-m)</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for force in driving_forces %}
                                        {% if force.force != 0 %}
                                            <tr>
                                                <td class="text-start">{{ force.name }}</td>
                                                <td>{{ force.force|floatformat:3 }}</td>
                                                <td>{% if force.arm != '-' %}{{ force.arm|floatformat:3 }}{% else %}
                                                    -{% endif %}</td>
                                                <td>{{ force.moment|floatformat:3 }}</td>
                                            </tr>
                                        {% endif %}
                                    {% endfor %}
                                    <tr class="table-dark fw-bold">
                                        <td class="text-start">總計 (Total Driving)</td>
                                        <td>{{ P_total|floatformat:3 }}</td>
                                        <td>{{ y_resultant|floatformat:3 }}</td>
                                        <td>{{ M_total|floatformat:3 }}</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="alert alert-warning mt-2"><strong>註：</strong> 額外垂直穩定分量 (Pv) =
                                <strong>{{ Pv_total }} tf/m</strong> (來自牆背傾斜與摩擦的垂直分力，應加入抵抗力計算)。
                            </div>
                        </div>

                        <!-- Tab 3: 被動抵抗力 -->
                        <div class="tab-pane fade" id="resisting" role="tabpanel">
                            <h5 class="text-success border-bottom pb-2">被動土壓力總表</h5>
                            <div class="table-responsive mb-4">
                                <table class="table table-striped table-hover text-center align-middle">
                                    <thead class="table-success">
                                    <tr>
                                        <th>部位</th>
                                        <th>靜態阻力 Pp (tf/m)</th>
                                        <th>動態阻力 Ppe (tf/m)</th>
                                        <th>力臂 Y (m)</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for force in passive_forces %}
                                        <tr>
                                            <td class="text-start">{{ force.name }}</td>
                                            <td>{{ force.static|floatformat:3 }}</td>
                                            <td>{{ force.dynamic|floatformat:3 }}</td>
                                            <td>{{ force.arm|floatformat:3 }} <span
                                                    class="text-muted small">(自版底)</span></td>
                                        </tr>
                                    {% endfor %}
                                    <tr class="table-dark fw-bold">
                                        <td class="text-start">總計 (Total Passive)</td>
                                        <td>{{ Pp_total|floatformat:3 }}</td>
                                        <td>{{ Ppe_total|floatformat:3 }}</td>
                                        <td>-</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            {% if key_details.has_key %}
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark fw-bold">止滑榫詳細應力分析</div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-md-6"><h6><span class="badge bg-secondary">有效超載</span>
                                            </h6>
                                                <p>q' = <strong>{{ key_details.q_eff|floatformat:3 }}</strong> tf/m²<br><small
                                                        class="text-muted">(Soil: {{ key_details.q_soil_part|floatformat:2 }}
                                                    + Conc: {{ key_details.q_conc_part|floatformat:2 }})</small></p>
                                                <p>gamma' = {{ key_details.gamma_base_eff|floatformat:3 }} tf/m³</p>
                                            </div>
                                            <div class="col-md-6"><h6><span class="badge bg-secondary">係數</span></h6>
                                                <p>Kp={{ Kp_base }}, Kpe={{ Kpe_base }}</p></div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered text-center">
                                                <thead class="table-light">
                                                <tr>
                                                    <th>狀態</th>
                                                    <th>Top Stress</th>
                                                    <th>Bot Stress</th>
                                                    <th>Force</th>
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr>
                                                    <td>靜態</td>
                                                    <td>{{ key_details.pp2_top|floatformat:3 }}</td>
                                                    <td>{{ key_details.pp2_bot|floatformat:3 }}</td>
                                                    <td class="fw-bold">{{ passive_forces.1.static|floatformat:3 }}</td>
                                                </tr>
                                                <tr>
                                                    <td>動態</td>
                                                    <td>{{ key_details.ppe2_top|floatformat:3 }}</td>
                                                    <td>{{ key_details.ppe2_bot|floatformat:3 }}</td>
                                                    <td class="fw-bold">{{ passive_forces.1.dynamic|floatformat:3 }}</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Tab 4: 自重 -->
                        <div class="tab-pane fade" id="weight" role="tabpanel">
                            <h5 class="text-secondary border-bottom pb-2">結構自重明細</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover text-center">
                                    <thead class="table-light">
                                    <tr>
                                        <th>幾何塊</th>
                                        <th>重量 (tf/m)</th>
                                        <th>對牆趾力矩 (tf-m)</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for block in blocks %}
                                        <tr>
                                            <td class="text-start">{{ block.name }}</td>
                                            <td>{{ block.weight|floatformat:3 }}</td>
                                            <td>{{ block.moment|floatformat:3 }}</td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                {% else %}
                    <div class="alert alert-warning text-center">尚未提交計算資料。</div>
                {% endif %}
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                <a href="{% url 'retaining_wall_cantilever:report_view' %}" target="_blank" class="btn btn-success"><i
                        class="bi bi-file-earmark-pdf"></i> 製作報告書</a>
                <button type="button" class="btn btn-primary" onclick="window.print()">列印本頁</button>
            </div>
        </div>
    </div>
</div>